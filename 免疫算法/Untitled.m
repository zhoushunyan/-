%%%%%免疫算法TSP问题%%%%
%%%%%初始化参数%%%%%
clear all;      %清除所有变量
close all;      %清图
clc;            %清屏
C1=[1150.0 1760.0;... 
630.0 1660.0;...
40.0 2090.0;... 
750.0 1100.0;... 
750.0 2030.0;... 
1030.0 2070.0;... 
1650.0 650.0;... 
1490.0 1630.0;...
790.0 2260.0;... 
1710.0 1310.0;... 
840.0 550.0;... 
1170.0 2300.0;... 
970.0 1340.0;... 
510.0 700.0;... 
750.0 900.0;... 
1280.0 1200.0;... 
230.0 590.0;... 
460.0 860.0;... 
1040.0 950.0;... 
590.0 1390.0;... 
830.0 1770.0;... 
490.0 500.0;...
1840.0 1240.0;... 
1260.0 1500.0;... 
1280.0 790.0;... 
490.0 2130.0;... 
1460.0 1420.0;... 
1260.0 1910.0;... 
360.0 1980.0;];

C=[
41 94;... 
37 84;...
54 67;...
25 62;...
7 64;...
2 99;...
68 58;...
71 44;...
54 62;...
83 69;...
64 60;...
18 54;...
22 60;...
83 46;...
91 38;...
25 38;...
24 42;...
58 69;...
71 71;...
74 78;...
87 76;...
18 40;...
13 40;...
82 7;...
62 32;...
58 35;...
45 21;...
41 26;...
44 35;...
4 50;...
];
N=size(C,1);    %城市数目，基因数目
D=zeros(N);     %任意两个城市距离矩阵
NP=500;         %免疫个体数目
G=5000;         %最大免疫代数
Pc=0.1;         %交叉率
f=zeros(N,NP);  %中间变量
len=zeros(NP,1);
%%%%%求间距%%%%%
for i=1:N
    for j=1:N
        D(i,j)=((C(i,1)-C(j,1))^2+(C(i,2)-C(j,2))^2)^0.5;
    end
end
%%%%%随机生成第一代%%%%%
for i=1:NP
    f(:,i)=randperm(N);
end
%%%%%计算路径长度%%%%%
 for i=1:NP
     len(i)=func3(D,f(:,i),N);
 end
[Sortlen,Index]=sort(len);
Sortf=f(:,Index);
Ncl=10;             %克隆个数
%%%%%遗传算法循环%%%%%
for gen=1:G
   for i=1:NP/2
    %%%%%选择操作%%%%%
    a=Sortf(:,i);
    Ca=repmat(a,1,Ncl);
    for j=1:Ncl
        p1=floor(1+N*rand());
        p2=floor(1+N*rand());
        while p1==p2
            p1=floor(1+N*rand());
            p2=floor(1+N*rand());
        end
        tmp=Ca(p1,j);
        Ca(p1,j)=Ca(p2,j);
        Ca(p2,j)=tmp;
    end
    Ca(:,1)=Sortf(:,i);
    %%%%%克隆抑制%%%%%
    for j=1:Ncl
        Calen(j)=func3(D,Ca(:,j),N);
    end
    [SortCalen,Index]=sort(Calen);
    SortCa=Ca(:,Index);
    af(:,i)=SortCa(:,1);
    alen(i)=SortCalen(1);
   end
   %%%%%种群刷新%%%%%
   for i=1:NP/2
       bf(:,i)=randperm(N);
       blen(i)=func3(D,bf(:,i),N);
   end
   %%%%%免疫种群与新种群合并%%%%%
   f=[af,bf];
   len=[alen,blen];
   [Sortlen,Index]=sort(len);
   Sortf=f(:,Index);
   trace(gen)=Sortlen(1);
end
%%%%%输出最优化结果%%%%%
fBest=Sortf(:,1);
Bestlen=trace(end);
figure
for i=1:N-1
    plot([C(fBest(i),1),C(fBest(i+1),1)],[C(fBest(i),2),C(fBest(i+1),2)],'bo-')
    hold on
end
plot([C(fBest(N),1),C(fBest(1),1)],[C(fBest(N),2),C(fBest(1),2)],'bo-')
title(['最优化距离',num2str(Bestlen)]);
figure
plot(trace)
xlabel('迭代次数')
ylabel('目标函数值')
title('亲和度进化曲线')